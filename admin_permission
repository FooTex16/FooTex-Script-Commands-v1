-- =============================================
-- 🔐 ADMIN + PERMISSION SYSTEM (FINAL VERSION)
-- =============================================

-- ✅ Daftar pemain dengan izin tetap (whitelist)
PERMISSION_WHITELIST = {
    ["DINA"] = true, -- Ganti dengan nama-nama yang diizinkan
    ["Owner123"] = true
}

-- 📌 Batas maksimal pemberian item
MAX_GIVE = 99

-- 🔧 Variabel command & izin dinamis
commandPrefix = "/"
commandList = {}
givePermission = {} -- UID yang sudah diberi izin via /grantgive

-- 🔍 Fungsi: nama → UID
function nametouid(name)
    local _, _, list = World:getAllPlayers(-1)
    for _, pid in ipairs(list) do
        local _, nick = Player:getNickname(pid)
        if nick == name then
            return pid
        end
    end
    return nil
end

-- 🏆 Cek apakah host (jika isHost tidak tersedia)
function isHost(pid)
    if Player.isHost then
        return Player:isHost(pid) == true
    end
    local _, _, list = World:getAllPlayers(-1)
    local minPid = nil
    for _, p in ipairs(list) do
        if not minPid or p < minPid then minPid = p end
    end
    return pid == minPid
end

-- 🔐 Cek apakah punya izin penuh
function hasGivePermission(pid)
    local _, name = Player:getNickname(pid)
    return isHost(pid) or givePermission[pid] or PERMISSION_WHITELIST[name] == true
end

-- ✅ Fungsi global agar bisa dibaca script lain
function isPermitted(pid)
    local _, name = Player:getNickname(pid)
    return isHost(pid) or givePermission[pid] or PERMISSION_WHITELIST[name] == true
end

function isPermittedByName(name)
    return PERMISSION_WHITELIST[name] == true
end

function getAllPermittedNames()
    local permittedNames = {}

    -- Dari whitelist
    for name, _ in pairs(PERMISSION_WHITELIST) do
        table.insert(permittedNames, name)
    end

    -- Dari UID yang diberikan izin
    for uid, _ in pairs(givePermission) do
        local _, name = Player:getNickname(uid)
        if name then
            table.insert(permittedNames, name)
        end
    end

    return permittedNames
end

-- 🔧 Pendaftaran command
function registerCommand(name, func)
    commandList[name] = func
end

-- =============================================
-- 📜 COMMANDS: GRANT / REVOKE / LIST / HOST
-- =============================================

-- Beri izin /give
registerCommand("grantgive", function(pid, target)
    local _, name = Player:getNickname(pid)
    if not (isHost(pid) or PERMISSION_WHITELIST[name]) then
        Chat:sendSystemMsg("⛔ Hanya host atau whitelist yang bisa memberikan izin.", pid)
        return
    end
    local tp = tonumber(target) or nametouid(target)
    if not tp then
        Chat:sendSystemMsg("❌ Target tidak ditemukan!", pid)
        return
    end
    givePermission[tp] = true
    Chat:sendSystemMsg("✅ Izin /give diberikan ke pemain.", pid)
    Chat:sendSystemMsg("📜 Kamu sekarang memiliki izin /give.", tp)
end)

-- Cabut izin /give
registerCommand("revoke", function(pid, target)
    local _, name = Player:getNickname(pid)
    if not (isHost(pid) or PERMISSION_WHITELIST[name]) then
        Chat:sendSystemMsg("⛔ Hanya host atau whitelist yang bisa mencabut izin.", pid)
        return
    end
    local tp = tonumber(target) or nametouid(target)
    if not tp then
        Chat:sendSystemMsg("❌ Target tidak ditemukan!", pid)
        return
    end
    givePermission[tp] = nil
    Chat:sendSystemMsg("⛔ Izin /give dicabut.", pid)
    Chat:sendSystemMsg("❌ Kamu tidak lagi memiliki izin /give.", tp)
end)

-- Daftar pemain yang punya izin
registerCommand("listperm", function(pid)
    Chat:sendSystemMsg("🧾 Pemain dengan izin /give:", pid)
    for uid, _ in pairs(givePermission) do
        local _, name = Player:getNickname(uid)
        if name then
            Chat:sendSystemMsg("✅ " .. name .. " (" .. uid .. ")", pid)
        end
    end
    for name, _ in pairs(PERMISSION_WHITELIST) do
        Chat:sendSystemMsg("🔒 Whitelist: " .. name, pid)
    end
end)

-- Cek apakah kamu host
registerCommand("amihost", function(pid)
    if isHost(pid) then
        Chat:sendSystemMsg("✅ Kamu adalah host!", pid)
    else
        Chat:sendSystemMsg("❌ Kamu BUKAN host.", pid)
    end
end)

-- =============================================
-- 💬 CHAT PARSER UNTUK COMMAND (EVENT)
-- =============================================

if not unpack and table.unpack then
    unpack = table.unpack
end

ScriptSupportEvent:registerEvent("Player.NewInputContent", function(event)
    local pid = event.eventobjid
    local msg = event.content

    if msg:sub(1, 1) ~= "/" then return end -- hanya command

    local args = {}
    for word in msg:gmatch("%S+") do
        table.insert(args, word)
    end

    local cmd = args[1]:sub(2):lower()
    local func = commandList[cmd]
    if func then
        table.remove(args, 1)
        func(pid, unpack(args))
    end
end)
